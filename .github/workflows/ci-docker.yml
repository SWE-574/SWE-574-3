name: CI — Docker

on:
  push:
    branches: [dev]
    paths:
      - "docker-compose*.yml"
      - "backend/Dockerfile*"
      - "frontend/Dockerfile*"
      - "nginx/**"
      - ".github/workflows/ci-docker.yml"
  pull_request:
    branches: [dev]

jobs:
  # ── 1. Infra stack (docker-compose.infra.yml) ────────────────────────────────
  infra:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Write .env
        run: cp .env.example .env

      - name: Start infra
        run: docker compose -f docker-compose.infra.yml up -d

      - name: Health-check PostGIS
        run: |
          for i in $(seq 1 10); do
            docker compose -f docker-compose.infra.yml exec -T db \
              pg_isready -U postgres && break
            echo "Waiting for PostGIS... ($i/10)"
            sleep 3
          done

      - name: Health-check Redis
        run: |
          docker compose -f docker-compose.infra.yml exec -T redis \
            redis-cli ping | grep -q PONG

      - name: Tear down
        if: always()
        run: docker compose -f docker-compose.infra.yml down -v

  # ── 2. Full local stack (docker-compose.yml) ─────────────────────────────────
  full-local:
    runs-on: ubuntu-latest
    needs: infra
    steps:
      - uses: actions/checkout@v4

      - name: Write .env
        run: |
          cp .env.example .env
          sed -i 's|DB_HOST=localhost|DB_HOST=db|' .env
          sed -i 's|REDIS_HOST=localhost|REDIS_HOST=redis|' .env
          echo "SECRET_KEY=ci-secret-key-not-used-in-production" >> .env
          echo "DEBUG=True" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1" >> .env

      - name: Build & start stack
        run: docker compose up -d --build

      - name: Wait for all containers healthy
        run: |
          for i in $(seq 1 20); do
            UNHEALTHY=$(docker compose ps --format json \
              | python3 -c "
          import sys, json
          rows = [json.loads(l) for l in sys.stdin if l.strip()]
          bad = [r['Name'] for r in rows if r.get('Health','') not in ('healthy','')]
          print('\n'.join(bad))
              ")
            [ -z "$UNHEALTHY" ] && echo "All containers healthy." && break
            echo "Still waiting: $UNHEALTHY  ($i/20)"
            sleep 5
          done

      - name: Seed demo data
        run: |
          docker compose exec -T backend \
            bash -lc "cd /code && DJANGO_SETTINGS_MODULE=hive_project.settings python setup_demo.py"

      - name: Smoke-test API health endpoint
        run: |
          curl --fail --retry 5 --retry-delay 3 --retry-connrefused \
            http://localhost/api/health/

      - name: Tear down
        if: always()
        run: docker compose down -v

  # ── 3. Prod stack (docker-compose.prod.yml) ──────────────────────────────────
  prod:
    runs-on: ubuntu-latest
    needs: full-local
    steps:
      - uses: actions/checkout@v4

      - name: Generate self-signed TLS certificate for CI
        # Run openssl inside a throw-away container so the cert lands on the
        # Docker-host filesystem (not just inside the act runner container).
        # docker-compose.prod.yml mounts /tmp/letsencrypt from the Docker HOST,
        # so the cert must exist there — not only in the act runner's /tmp.
        run: |
          docker run --rm \
            -v /tmp/letsencrypt:/etc/letsencrypt \
            alpine sh -c "
              apk add --no-cache openssl > /dev/null 2>&1
              mkdir -p /etc/letsencrypt/live/localhost
              openssl req -x509 -nodes -days 1 \
                -newkey rsa:2048 \
                -keyout /etc/letsencrypt/live/localhost/privkey.pem \
                -out    /etc/letsencrypt/live/localhost/fullchain.pem \
                -subj   '/CN=localhost'
            "

      - name: Write .env
        run: |
          cat > .env <<'EOF'
          DB_NAME=the_hive_db
          DB_USER=postgres
          DB_PASSWORD=ci_prod_password
          SECRET_KEY=ci-secret-key-not-used-in-production
          DEBUG=False
          ALLOWED_HOSTS=localhost,127.0.0.1
          CORS_ALLOWED_ORIGINS=https://localhost
          DOMAIN=localhost
          VITE_API_URL=/api
          LETSENCRYPT_DIR=/tmp/letsencrypt
          EOF

      - name: Build & start prod stack
        # env: overrides prevent locally-injected variables (e.g. from act reading
        # the project .env) from shadowing the CI values set in "Write .env" above.
        env:
          DOMAIN: localhost
          LETSENCRYPT_DIR: /tmp/letsencrypt
          SECRET_KEY: ci-secret-key-not-used-in-production
          DB_PASSWORD: ci_prod_password
          ALLOWED_HOSTS: "localhost,127.0.0.1"
          CORS_ALLOWED_ORIGINS: "https://localhost"
          DEBUG: "False"
        run: docker compose -f docker-compose.prod.yml up -d --build

      - name: Wait for all containers healthy
        run: |
          for i in $(seq 1 24); do
            UNHEALTHY=$(docker compose -f docker-compose.prod.yml ps --format json \
              | python3 -c "
          import sys, json
          rows = [json.loads(l) for l in sys.stdin if l.strip()]
          bad = [r['Name'] for r in rows if r.get('Health','') not in ('healthy','')]
          print('\n'.join(bad))
              ")
            [ -z "$UNHEALTHY" ] && echo "All containers healthy." && break
            echo "Still waiting: $UNHEALTHY  ($i/24)"
            sleep 5
          done

      - name: Run migrations
        run: |
          docker compose -f docker-compose.prod.yml exec -T backend \
            python manage.py migrate --no-input

      - name: Seed demo data
        run: |
          docker compose -f docker-compose.prod.yml exec -T backend \
            bash -lc "cd /code && DJANGO_SETTINGS_MODULE=hive_project.settings python setup_demo.py"

      - name: Smoke-test API health endpoint (HTTPS, self-signed cert)
        run: |
          curl --fail --insecure --retry 5 --retry-delay 3 --retry-connrefused \
            https://localhost/api/health/

      - name: Smoke-test frontend
        run: |
          curl --fail --insecure --retry 5 --retry-delay 3 --retry-connrefused \
            https://localhost/

      - name: Tear down
        if: always()
        run: docker compose -f docker-compose.prod.yml down -v
